# log-puller

This app runs on Heroku and points to the cc-log-manager app's database.  Its purpose
is to allow for filtered log data queries based on the user's portal credentials.

Currently the app exposes two endopints: /download and /view.  The both run the same
query but /download sets the Content-Disposition header so the result of the query
is downloaded in the browser whereas view just streams the result to the browser.

## How it works

Both the /download and /view endpoints require a lara_id and portal_token parameter and
can optionally take a class_id parameter that, if present, is added to each query row.
The class_id is currently being used by ETS to ensure that the data is all from a single
class.

The portal_token parameter is a signed JWT token generated by the portal whose payload
looks like the following:

```
{
  "exp": 1490728471,
  "uid": 1777,
  "claims": {
    "class_info_url": "https://learn.concord.org/api/v1/classes/2279"
  }
}
```

The log puller decodes the token and then performs a server side get to class_info_url
passing a header that looks like:

```
Authorization: Bearer/JWT <portal_token>
```

The result of that result looks like this:

```
{
"uri": "http://railsdev:9000/portal/classes/2279",
"name": "Intro to Electronics 4",
"state": "TX",
"class_hash": "11c24ee037e1c0c63073c34ba2cbd8f87a31fd1ba4f7f544",
"teachers": [
{
"id": "http://railsdev:9000/users/30498",
"first_name": "John",
"last_name": "Chamberlain"
}
],
"students": [
{
"id": "http://railsdev:9000/users/41668",
"email": "no-email-e6a567e2-d8e0-11e6-802b-0e33a14d70f1@concord.org",
"first_name": "John",
"last_name": "Master"
},
{
"id": "http://railsdev:9000/users/41727",
"email": "no-email-362da41a-d8e5-11e6-99dd-0e33a14d70f1@concord.org",
"first_name": "John",
"last_name": "master2"
},
{
"id": "http://railsdev:9000/users/41728",
"email": "no-email-ac8850f6-d8e5-11e6-949a-0e33a14d70f1@concord.org",
"first_name": "John",
"last_name": "Master3"
}
],
"lara_activities": [
{
"portal_id": 456,
"lara_id": 6833,
"name": "Teaching Teamwork - Three Resistors Field Test",
"remote_endpoint_urls": [
"http://railsdev:9000/dataservice/external_activity_data/8610f5fa-51b7-40de-a35c-aef6ff94347c",
"http://railsdev:9000/dataservice/external_activity_data/89901b1e-5b7b-4d9c-bc73-5372e767a9c4",
"http://railsdev:9000/dataservice/external_activity_data/671dc86e-b86d-4a32-92d8-3e27a56651f7"
]
},
{
"portal_id": 457,
"lara_id": 6834,
"name": "Teaching Teamwork - Three Resistors Field Test (Solo)",
"remote_endpoint_urls": []
}
]
}
```